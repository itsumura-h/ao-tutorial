# ハンドラー (バージョン 0.0.5)

## 概要

ハンドラーライブラリは、パターンマッチングに基づいて一連のプロセス関数を管理および実行する柔軟な方法を提供します。AOプロセスはメッセージを受信して応答します。これらのメッセージは、タグとデータからなるArweave DataItem仕様を使用して定義されます。ハンドラーライブラリを使用すると、AOメッセージの属性に基づいてプロセス評価のパイプラインを定義できます。各ハンドラーアイテムは、パターン関数、ハンドル関数、および名前で構成されます。このライブラリは、異なる入力条件に基づいて異なるアクションを実行する必要があるシナリオに適しています。

## コンセプト

### パターンマッチングテーブル

パターンマッチングテーブルは、受信メッセージのマッチング形状のテーブル表現を提供する概念です。以下はルールです：

```lua
{ "Action" = "Do-Something" } -- 含まれるべきタグのテーブルによる任意のメッセージをマッチング

{ "Recipient" = '_' } -- 任意の値を持つrecipientタグがあるメッセージをマッチング

{ "Quantity" = "%d+" } -- Lua文字列マッチ（正規表現に似た）によるタグの検証

{ "Quantity" = function(v) return tonumber(v) ~= nil end } -- タグをチェックする関数を適用。nilまたはfalseはマッチしない
```

例：

Actionが"Balance"に等しいすべてのメッセージにマッチする場合：

```lua
{ Action = "Balance" }
```

Quantityが数値であるすべてのメッセージにマッチする場合：

```lua
{ Quantity = "%d+" }
```

### リゾルバ

リゾルバは、各キーがパターンマッチングテーブルであり、値がマッチングキーに基づいて実行される関数であるテーブルです。これにより、開発者はリゾルバプロパティ内にcase-likeステートメントを作成できます。

```lua
Handlers.add("foobarbaz",
  { Action = "Update" }, {
  [{ Status = "foo" }] = function (msg) print("foo") end,
  [{ Status = "bar" }] = function (msg) print("bar") end,
  [{ Status = "baz" }] = function (msg) print("baz") end
})
```

## モジュール構造

- `Handlers._version`: ハンドラーライブラリのバージョンを表す文字列。
- `Handlers.list`: 登録されたハンドラーのリストを格納するテーブル。

## ハンドラー メソッド共通関数シグネチャ

| パラメータ         | タイプ                       | 説明                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| ------------------ | ---------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| name               | string                       | ハンドラーリスト内のハンドラーアイテムの識別子。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| pattern            | Table または Function        | このパラメータは、メッセージがマッチする必要のあるパターンを指定するテーブルを取ることができます。例：`{ Action = "Balance", Recipient = "_" }` このテーブルは、Actionというタグがあり、その値が"Balance"であるメッセージ、および値を持つRecipientタグがあるメッセージを記述します。テーブルを介してパターンを追加できない場合は、メッセージDataItemを引数として受け取り、`true`、`false`または`"continue"`の結果を返す`function`を使用することもできます。`true`の結果は、ハンドラー評価パイプラインにこのハンドラーを呼び出し、パイプラインを終了するよう指示します。`false`の結果は、ハンドラー評価パイプラインにこのハンドラーをスキップし、パイプライン内の次のハンドラーアイテムが一致するパターンを見つけようとするよう指示します。最後に`"continue"`は、このハンドラーを呼び出し、次のハンドラーの評価を続行するよう指示します。 |
| handler            | Table (Resolver) または Function | このパラメータは、パターンマッチングキーに基づいて関数を呼び出す条件として機能するテーブル、またはメッセージDataItemを引数として受け取り、いくつかのビジネスロジックを実行する関数を取ることができます。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| maxRuns (optional) | number                       | バージョン0.0.5以降、各ハンドラー関数は、ハンドラーが削除される前にマッチする回数を定義するオプションの関数を取ります。デフォルトは無限です。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |

## 関数

### `Handlers.add(name, pattern, handler)`

新しいハンドラーを追加するか、名前で既存のハンドラーを更新します。

### `Handlers.append(name, pattern, handler)`

ハンドラーリストの最後に新しいハンドラーを追加します。

### `Handlers.once(name, pattern, handler)`

パターンが一致したときに一度だけ実行します。

### `Handlers.prepend(name, pattern, handler)`

ハンドラーリストの最初に新しいハンドラーを追加します。

### `Handlers.before(handleName)`

指定されたハンドラーの前に新しいハンドラーを追加するオブジェクトを返します。

### `Handlers.after(handleName)`

指定されたハンドラーの後に新しいハンドラーを追加するオブジェクトを返します。

### `Handlers.remove(name)`

名前でハンドラーリストからハンドラーを削除します。

## 例

### パターンテーブルの使用

```lua
Handlers.add("ping",
  { Action = "ping" },
  function (msg)
    print('ping')
    msg.reply({Data = "pong" })
  end
)
```

### リゾルバの使用

```lua
Handlers.add(
  "foobarbaz",
  { Action = "Speak" }, {
  [{Status = "foo"}] = function (msg) print("foo") end,
  [{Status = "bar"}] = function (msg) print("bar") end,
  [{Status = "baz"}] = function (msg) print("baz") end
})
```

### 関数の使用

```lua
Handlers.add("example",
  function (msg)
    return msg.Action == "Speak"
  end,
  function (msg)
    print(msg.Status)
  end
)
```

## 注意事項

- ハンドラーは`handlers.list`に表示される順序で実行されます。
- パターン関数は、ハンドラーをスキップするには`false`を返し、ハンドラーが実行された後に終了するには`true`を返し、ハンドラーを実行して次のハンドラーの評価を続行するには`"continue"`を返す必要があります。

## Handlers.utils

Handlers.utilsモジュールは、一般的なマッチングパターンの2つの関数と、一般的なハンドル関数を提供します。

- hasMatchingData(data)
- hasMatchingTag(name, value)
- reply(txt)

### Handlers.utils.hasMatchingData(data : string)

このヘルパーは、メッセージ引数を必要とする関数を返しますので、任意のハンドラーのパターン引数にこれを挿入できます。この関数は、受信メッセージのデータを引数として提供された文字列と比較します。

```lua
Handlers.add("ping",
    Handlers.utils.hasMatchingData("ping"),
    ...
)
```

データがpingに設定されたメッセージがプロセスに到着すると、このハンドラーはそれにマッチし、ハンドル関数を呼び出します。

### Handlers.hasMatchingTag(name : string, value : string)

このヘルパーは、メッセージ引数を必要とする関数を返しますので、Handlersモジュールの任意のパターン引数にこれを挿入できます。この関数は、タグ名と値を比較し、それらが等しい場合にハンドル関数を呼び出します。

```lua
Handlers.add("ping",
    Handlers.utils.hasMatchingData("ping"),
    ...
)
```

### Handlers.reply(text : string)

このヘルパーはシンプルなハンドル関数で、基本的にテキスト値をアウトバウンドメッセージのデータプロパティに配置します。

```lua
Handlers.add("ping",
    Handlers.utils.hasMatchingData("ping"),
    Handlers.utils.reply("pong")
)
```
